function ENV(){const e="function"==typeof require&&"undefined"!=typeof $jsbox;return{isQX:"undefined"!=typeof $task,isLoon:"undefined"!=typeof $loon,isSurge:"undefined"!=typeof $httpClient&&"undefined"!=typeof $utils,isBrowser:"undefined"!=typeof document,isNode:"function"==typeof require&&!e,isJSBox:e,isRequest:"undefined"!=typeof $request,isScriptable:"undefined"!=typeof importModule}}function _extend(){let e=arguments[0]||{};for(let t=1;t<arguments.length;t++){let s=arguments[t];for(let t in s)Object.prototype.hasOwnProperty.call(s,t)&&("object"==typeof s[t]&&null!==s[t]?e[t]=_extend(e[t],s[t]):e[t]=s[t])}return e}function HTTP(e={baseURL:""}){const{isQX:t,isLoon:s,isSurge:n,isScriptable:o,isNode:i,isBrowser:r}=ENV(),u=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/;const l={};return["GET","POST","PUT","DELETE","HEAD","OPTIONS","PATCH"].forEach((a=>l[a.toLowerCase()]=l=>function(l,a){a="string"==typeof a?{url:a}:a;const d=e.baseURL;d&&!u.test(a.url||"")&&(a.url=d?d+a.url:a.url);const h=(a=_extend({headers:{"Content-Type":"application/x-www-form-urlencoded"}},e,a)).timeout,c={onRequest:()=>{},onResponse:e=>e,onTimeout:()=>{},...a.events};let f,p;if(c.onRequest(l,a),t)f=$task.fetch({method:l,...a});else if(s||n||i)f=new Promise(((e,t)=>{(i?require("request"):$httpClient)[l.toLowerCase()](a,((s,n,o)=>{s?t(s):e({statusCode:n.status||n.statusCode,headers:n.headers,body:o})}))}));else if(o){const e=new Request(a.url);e.method=l,e.headers=a.headers,e.body=a.body,f=new Promise(((t,s)=>{e.loadString().then((s=>{t({statusCode:e.response.statusCode,headers:e.response.headers,body:s})})).catch((e=>s(e)))}))}else r&&(f=new Promise(((e,t)=>{fetch(a.url,{method:l,headers:a.headers,body:a.body}).then((e=>e.json())).then((t=>e({statusCode:t.status,headers:t.headers,body:t.data}))).catch(t)})));const y=h?new Promise(((e,t)=>{p=setTimeout((()=>(c.onTimeout(),t(`${l} URL: ${a.url} exceeds the timeout ${h} ms`))),h)})):null;return(y?Promise.race([y,f]).then((e=>(clearTimeout(p),e))):f).then((e=>c.onResponse(e)))}(a,l))),l}function API(e="untitled",t=!1){const{isQX:s,isLoon:n,isSurge:o,isNode:i,isJSBox:r,isScriptable:u}=ENV();return new class{constructor(e,t){this.name=e,this.debug=t,this.http=HTTP(),this.env=ENV(),this.node=(()=>{if(i){return{fs:require("fs")}}return null})(),this.initCache();Promise.prototype.delay=function(e){return this.then((function(t){return((e,t)=>new Promise((function(s){setTimeout(s.bind(null,t),e)})))(e,t)}))}}initCache(){if(s&&(this.cache=JSON.parse($prefs.valueForKey(this.name)||"{}")),(n||o)&&(this.cache=JSON.parse($persistentStore.read(this.name)||"{}")),i){let e="root.json";this.node.fs.existsSync(e)||this.node.fs.writeFileSync(e,JSON.stringify({}),{flag:"wx"},(e=>console.log(e))),this.root={},e=`${this.name}.json`,this.node.fs.existsSync(e)?this.cache=JSON.parse(this.node.fs.readFileSync(`${this.name}.json`)):(this.node.fs.writeFileSync(e,JSON.stringify({}),{flag:"wx"},(e=>console.log(e))),this.cache={})}}persistCache(){const e=JSON.stringify(this.cache,null,2);s&&$prefs.setValueForKey(e,this.name),(n||o)&&$persistentStore.write(e,this.name),i&&(this.node.fs.writeFileSync(`${this.name}.json`,e,{flag:"w"},(e=>console.log(e))),this.node.fs.writeFileSync("root.json",JSON.stringify(this.root,null,2),{flag:"w"},(e=>console.log(e))))}write(e,t){if(this.log(`SET ${t}`),-1!==t.indexOf("#")){if(t=t.substr(1),o||n)return $persistentStore.write(e,t);if(s)return $prefs.setValueForKey(e,t);i&&(this.root[t]=e)}else this.cache[t]=e;this.persistCache()}read(e){return this.log(`READ ${e}`),-1===e.indexOf("#")?this.cache[e]:(e=e.substr(1),o||n?$persistentStore.read(e):s?$prefs.valueForKey(e):i?this.root[e]:void 0)}delete(e){if(this.log(`DELETE ${e}`),-1!==e.indexOf("#")){if(e=e.substr(1),o||n)return $persistentStore.write(null,e);if(s)return $prefs.removeValueForKey(e);i&&delete this.root[e]}else delete this.cache[e];this.persistCache()}notify(e,t="",l="",a={}){const d=a["open-url"],h=a["media-url"];if(s&&$notify(e,t,l,a),o&&$notification.post(e,t,l+""+(h?"\n多媒体:"+h:""),{url:d}),n){let s={};d&&(s.openUrl=d),h&&(s.mediaUrl=h),"{}"===JSON.stringify(s)?$notification.post(e,t,l):$notification.post(e,t,l,s)}if(i||u){const s=l+(d?`\n点击跳转: ${d}`:"")+(h?`\n多媒体: ${h}`:"");if(r){require("push").schedule({title:e,body:(t?t+"\n":"")+s})}else console.log(`${e}\n${t}\n${s}\n\n`)}}log(e){this.debug&&console.log(`[${this.name}] LOG: ${this.stringify(e)}`)}info(e){console.log(`[${this.name}] INFO: ${this.stringify(e)}`)}error(e){console.log(`[${this.name}] ERROR: ${this.stringify(e)}`)}wait(e){return new Promise((t=>setTimeout(t,e)))}done(e={}){s||n||o?$done(e):i&&!r&&"undefined"!=typeof $context&&($context.headers=e.headers,$context.statusCode=e.statusCode,$context.body=e.body)}stringify(e){if("string"==typeof e||e instanceof String)return e;try{return JSON.stringify(e,null,2)}catch(t){return Object.prototype.toString.call(e)}}extend(){return 1===arguments.length?_extend(this,arguments[0]):_extend(...arguments)}json2QueryString(e){return Object.keys(e).map((t=>encodeURIComponent(t)+"="+encodeURIComponent(e[t]))).join("&")}}(e,t)}